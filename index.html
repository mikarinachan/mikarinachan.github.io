<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>数学メモ</title>
  <link rel="stylesheet" href="style.css">

  <!-- MathJax -->
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$']]
      }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" defer></script>
</head>

<body>
<header>
  <h1>数学メモ</h1>
  <p>思いついた問題・証明・違和感を投げる場所</p>
</header>

<main id="timeline"></main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    getDocs,
    query,
    where
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCfyTtuLXAmibDu2ebKSTUI-_ZKFrv8Syo",
    authDomain: "math-memo-870c0.firebaseapp.com",
    projectId: "math-memo-870c0",
    storageBucket: "math-memo-870c0.firebasestorage.app",
    messagingSenderId: "396039327636",
    appId: "1:396039327636:web:028aa61574d06623240981"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  fetch("posts.json")
    .then(res => res.json())
    .then(async posts => {
      const area = document.getElementById("timeline");

      for (const p of posts.reverse()) {
        const ratedKey = `rated_${p.id}`;
        const alreadyRated = localStorage.getItem(ratedKey);

        const q = query(collection(db, "ratings"), where("postId", "==", p.id));
        const snap = await getDocs(q);
        const scores = snap.docs.map(d => d.data().score);
        const avg = scores.length
          ? (scores.reduce((a,b)=>a+b,0)/scores.length).toFixed(2)
          : "未評価";

        const div = document.createElement("div");
        div.className = "post";

        div.innerHTML = `
          <div class="meta">${p.date}｜${p.source}</div>

          <pre class="content">${p.body}</pre>

          ${p.explain ? `<div class="explain">解説：${p.explain}</div>` : ""}

          <div class="avg">平均難易度：<b>${avg}</b></div>

          <div class="rating">
            ${[1,2,3,4,5,6,7,8,9,10].map(n =>
              `<button data-score="${n}" ${alreadyRated ? "disabled" : ""}>${n}</button>`
            ).join("")}
          </div>
        `;

        if (alreadyRated) {
          div.querySelector(`[data-score="${alreadyRated}"]`)?.classList.add("selected");
        }

        div.querySelectorAll("button").forEach(btn => {
          btn.onclick = async () => {
            if (localStorage.getItem(ratedKey)) return;

            const score = Number(btn.dataset.score);
            await addDoc(collection(db, "ratings"), {
              postId: p.id,
              score,
              createdAt: new Date()
            });

            localStorage.setItem(ratedKey, score);
            div.querySelectorAll("button").forEach(b => b.disabled = true);
            btn.classList.add("selected");
          };
        });

        area.appendChild(div);
      }

      MathJax.typeset();
    });
</script>
</body>
</html>
