<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>数学メモ</title>
<link rel="stylesheet" href="style.css">

<!-- MathJax -->
<script>
MathJax = {
  tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] }
};
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" defer></script>
</head>

<body>
<header>
  <h1>数学メモ</h1>
  <p>問題を投げる場所</p>
</header>

<main id="timeline"></main>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs, query, where
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCfyTtuLXAmibDu2ebKSTUI-_ZKFrv8Syo",
  authDomain: "math-memo-870c0.firebaseapp.com",
  projectId: "math-memo-870c0",
  storageBucket: "math-memo-870c0.appspot.com",
  messagingSenderId: "396039327636",
  appId: "1:396039327636:web:028aa61574d06623240981"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// 評価送信
window.rate = async (postId, score) => {
  await addDoc(collection(db, "ratings"), {
    postId,
    score,
    createdAt: new Date()
  });
  alert("評価ありがとう！");
};

// 平均取得
async function getAverage(postId) {
  const q = query(collection(db, "ratings"), where("postId", "==", postId));
  const snap = await getDocs(q);
  if (snap.empty) return "未評価";
  let sum = 0;
  snap.forEach(d => sum += d.data().score);
  return (sum / snap.size).toFixed(1);
}

// 投稿描画
fetch("posts.json")
.then(r => r.json())
.then(async posts => {
  const area = document.getElementById("timeline");
  posts.reverse();

  for (const p of posts) {
    const avg = await getAverage(p.id);

    const div = document.createElement("div");
    div.className = "post";
    div.innerHTML = `
      ${p.thumbnail ? `<img class="thumb" src="${p.thumbnail}">` : ""}
      <div class="meta">${p.date}</div>
      <div class="content">${p.body}</div>

      <button onclick="this.nextElementSibling.classList.toggle('show')">
        解説を見る
      </button>
      <div class="explain">${p.explain}</div>

      <div class="rating">
        難易度（平均 ${avg}）：
        ${[1,2,3,4,5,6,7,8,9,10].map(n =>
          `<button onclick="rate('${p.id}', ${n})">${n}</button>`
        ).join("")}
      </div>
    `;
    area.appendChild(div);
  }
  MathJax.typeset();
});
</script>
</body>
</html>
