<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>数学メモ</title>
  <link rel="stylesheet" href="style.css">

  <!-- MathJax -->
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$']]
      }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" defer></script>
</head>

<body>
<header>
  <h1>数学メモ</h1>
  <p>思いついた問題・証明・違和感を投げる場所</p>
</header>

<main id="timeline"></main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ---------- Firebase ---------- */

const firebaseConfig = {
  apiKey: "AIzaSyCfyTtuLXAmibDu2ebKSTUI-_ZKFrv8Syo",
  authDomain: "math-memo-870c0.firebaseapp.com",
  projectId: "math-memo-870c0",
  storageBucket: "math-memo-870c0.firebasestorage.app",
  messagingSenderId: "396039327636",
  appId: "1:396039327636:web:028aa61574d06623240981"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ---------- DOM ---------- */

const timeline = document.getElementById("timeline");

/* ---------- posts.json 読み込み ---------- */

const posts = await fetch("posts.json").then(r => r.json());

/* ---------- 各 .tex を読み込む ---------- */

for (const p of posts) {
  if (!p.tex) {
    p.body = "";
    continue;
  }
  const tex = await fetch(p.tex).then(r => r.text());
  p.body = tex;
}

/* ---------- ratings 全件取得 ---------- */

const ratingSnap = await getDocs(collection(db, "ratings"));
const ratingMap = {};

ratingSnap.forEach(doc => {
  const { postId, score } = doc.data();
  if (!ratingMap[postId]) ratingMap[postId] = [];
  ratingMap[postId].push(score);
});

/* ---------- 投稿データ拡張 ---------- */

const enriched = posts.map(p => {
  const scores = ratingMap[p.id] ?? [];
  const avg = scores.length
    ? scores.reduce((a,b)=>a+b,0) / scores.length
    : 0;

  return {
    ...p,
    avg,
    count: scores.length
  };
});

/* ---------- 難易度順 ---------- */

enriched.sort((a,b) => b.avg - a.avg);

/* ---------- 描画 ---------- */

for (const p of enriched) {
  const ratedKey = `rated_${p.id}`;
  const alreadyRated = localStorage.getItem(ratedKey);

  const div = document.createElement("div");
  div.className = "post";

  div.innerHTML = `
    <div class="meta">${p.date}｜${p.source}</div>

    <div class="content">
      $$${p.body}$$
    </div>

    ${p.explain ? `<div class="explain">解説：${p.explain}</div>` : ""}

    ${p.answer ? `
      <div class="answer">
        <a href="${p.answer}" target="_blank">▶ 模範解答を見る</a>
      </div>` : ""}

    <div class="avg" data-avg>
      平均難易度：<b>${p.count ? p.avg.toFixed(2) : "未評価"}</b>
      ${p.count ? `（${p.count}人）` : ""}
    </div>

    <div class="rating">
      ${[1,2,3,4,5,6,7,8,9,10].map(n =>
        `<button data-score="${n}" ${alreadyRated ? "disabled" : ""}>${n}</button>`
      ).join("")}
    </div>
  `;

  const avgDiv = div.querySelector("[data-avg]");

  if (alreadyRated) {
    div.querySelector(`[data-score="${alreadyRated}"]`)
      ?.classList.add("selected");
  }

  div.querySelectorAll("button").forEach(btn => {
    btn.onclick = async () => {
      if (localStorage.getItem(ratedKey)) return;

      const score = Number(btn.dataset.score);

      await addDoc(collection(db, "ratings"), {
        postId: p.id,
        score,
        createdAt: new Date()
      });

      // 即時反映
      const newAvg = (p.avg * p.count + score) / (p.count + 1);
      p.avg = newAvg;
      p.count += 1;

      avgDiv.innerHTML =
        `平均難易度：<b>${newAvg.toFixed(2)}</b>（${p.count}人）`;

      localStorage.setItem(ratedKey, score);
      div.querySelectorAll("button").forEach(b => b.disabled = true);
      btn.classList.add("selected");
    };
  });

  timeline.appendChild(div);
}

/* ---------- MathJax 再描画 ---------- */

MathJax.typesetPromise();

</script>
</body>
</html>
